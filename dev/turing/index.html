<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Turing integration · MarginalLogDensities.jl</title><meta name="title" content="Turing integration · MarginalLogDensities.jl"/><meta property="og:title" content="Turing integration · MarginalLogDensities.jl"/><meta property="twitter:title" content="Turing integration · MarginalLogDensities.jl"/><meta name="description" content="Documentation for MarginalLogDensities.jl."/><meta property="og:description" content="Documentation for MarginalLogDensities.jl."/><meta property="twitter:description" content="Documentation for MarginalLogDensities.jl."/><meta property="og:url" content="https://ElOceanografo.github.io/MarginalLogDensities.jl/turing/"/><meta property="twitter:url" content="https://ElOceanografo.github.io/MarginalLogDensities.jl/turing/"/><link rel="canonical" href="https://ElOceanografo.github.io/MarginalLogDensities.jl/turing/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">MarginalLogDensities.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Getting started</a></li><li><span class="tocitem">User guide</span><ul><li><a class="tocitem" href="../theory/">Theory</a></li><li><a class="tocitem" href="../sparse_ad/">Sparsity and AD</a></li><li><a class="tocitem" href="../tips/">Tips for success</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../hreg/">Hierarchical regression</a></li><li><a class="tocitem" href="../componentarrays/">Using ComponentArrays</a></li><li class="is-active"><a class="tocitem" href>Turing integration</a><ul class="internal"><li><a class="tocitem" href="#Model-definition"><span>Model definition</span></a></li><li><a class="tocitem" href="#Maximum-a-posteriori-optimization"><span>Maximum a-posteriori optimization</span></a></li><li><a class="tocitem" href="#MCMC-Sampling"><span>MCMC Sampling</span></a></li><li><a class="tocitem" href="#Un-linking-parameters"><span>Un-linking parameters</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Turing integration</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Turing integration</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ElOceanografo/MarginalLogDensities.jl/blob/master/docs/src/turing.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Turing.jl-integration"><a class="docs-heading-anchor" href="#Turing.jl-integration">Turing.jl integration</a><a id="Turing.jl-integration-1"></a><a class="docs-heading-anchor-permalink" href="#Turing.jl-integration" title="Permalink"></a></h1><p>Starting with Turing <a href="https://github.com/TuringLang/Turing.jl/releases/tag/v0.40.4">v0.40.4</a>  / DynamicPPL <a href="https://github.com/TuringLang/DynamicPPL.jl/releases/tag/v0.37.4">v0.37.4</a>, it is possible to construct a <code>MarginalLogDensity</code> directly from a Turing model,  specifying the variables to marginalize by their names.</p><h2 id="Model-definition"><a class="docs-heading-anchor" href="#Model-definition">Model definition</a><a id="Model-definition-1"></a><a class="docs-heading-anchor-permalink" href="#Model-definition" title="Permalink"></a></h2><p>Models can be defined using Turing&#39;s <code>@model</code> macro and probabilistic programming syntax.  Here, we define a simple model with a latent variable <code>x</code> that follows a Gaussian  distribution with mean <code>m</code> and covariance <code>C</code>.</p><pre><code class="language-julia hljs">using Turing
using MarginalLogDensities
using DynamicPPL
using Distributions
using LinearAlgebra
using StatsPlots
using Random

Random.seed!(4321)

r = 0.4
a = 2
n = 50
m = fill(a, n)
C = Tridiagonal(fill(-r, n-1), ones(n), fill(-r, n-1))
y = rand(MvNormal(m, C))
plot(y)

@model function demo(y)
    n = length(y)
    r ~ Uniform(-0.5, 0.5)
    a ~ Normal(0, 5)
    m ~ MvNormal(fill(a, n), 1)
    C = Tridiagonal(fill(-r, n-1), ones(n), fill(-r, n-1))

    y ~ MvNormal(m, C)
end

full = demo(y)
marginal = marginalize(full, [@varname(m)],
    sparsity_detector=DenseSparsityDetector(AutoForwardDiff(), atol=1e-9))

njoint(marginal)
marginal([0.1, 1.0])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">-134.115161310273</code></pre><h2 id="Maximum-a-posteriori-optimization"><a class="docs-heading-anchor" href="#Maximum-a-posteriori-optimization">Maximum a-posteriori optimization</a><a id="Maximum-a-posteriori-optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Maximum-a-posteriori-optimization" title="Permalink"></a></h2><pre><code class="language-julia hljs">using Optimization, OptimizationOptimJL

v0 = zeros(2)
opt_func = OptimizationFunction(marginal)
opt_prob = OptimizationProblem(opt_func, v0, ())
opt_sol = solve(opt_prob, NelderMead())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">retcode: Success
u: 2-element Vector{Float64}:
 -0.5730128723197265
  2.4437395059504627</code></pre><h2 id="MCMC-Sampling"><a class="docs-heading-anchor" href="#MCMC-Sampling">MCMC Sampling</a><a id="MCMC-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#MCMC-Sampling" title="Permalink"></a></h2><p>Sampling from a <code>MarginalLogDensity</code> is currently a bit more awkward than doing so from a Turing model, but not too bad. Keep in mind that <code>MarginalLogDensity</code> objects don&#39;t currently work with AD, so samplers must either be gradient free (like random-walk Metropolis Hastings), or use a finite-difference backend (e.g. <code>AutoFiniteDiff()</code>.)</p><p>The code below was adapted from @torfjelde&#39;s example on GitHub <a href="https://github.com/TuringLang/Turing.jl/issues/2398#issuecomment-2514212264">here</a>. We  request 100 samples with a thinning rate of 20 - that is, we&#39;ll run 2,000 samples and keep  every 20th one. We also set the inital parameters to the MAP optimum we found before,  which speeds up convergence in this case.</p><pre><code class="language-julia hljs">using AbstractMCMC, AdvancedMH

sampler = AdvancedMH.RWMH(njoint(marginal))
chain = sample(marginal, sampler, 100; chain_type=MCMCChains.Chains,
    thinning=20, initial_params=opt_sol.u,
    # HACK: this a dirty way to extract the variable names in a model; it won&#39;t work in general.
    param_names=setdiff(keys(DynamicPPL.untyped_varinfo(full)), [@varname(m)])
)
plot(chain)</code></pre><img src="c7dd523f.svg" alt="Example block output"/><p>These chains are short for the sake of the demo, but could easily be run longer to get a  smoother posterior.</p><p>Sampling using Hamiltonian Monte Carlo is possible, but is currently a bit more awkward. The following is adapted from the AdvancedHMC  <a href="https://turinglang.org/AdvancedHMC.jl/stable/get_started/">documentation</a>:</p><pre><code class="language-julia hljs">using AdvancedHMC
import FiniteDiff
using LogDensityProblems

# Set the number of samples to draw and warmup iterations
n_samples, n_adapts = 200, 100

# Define a Hamiltonian system
metric = DiagEuclideanMetric(njoint(marginal))
hamiltonian = Hamiltonian(metric, marginal, AutoFiniteDiff())
initial_ϵ = 0.4
integrator = Leapfrog(initial_ϵ)
kernel = HMCKernel(Trajectory{MultinomialTS}(integrator, GeneralisedNoUTurn()))
adaptor = StanHMCAdaptor(MassMatrixAdaptor(metric), StepSizeAdaptor(0.8, integrator))

samples, stats = sample(
    hamiltonian, kernel, opt_sol.u, n_samples, adaptor, n_adapts; progress=true,
)
plot(hcat(samples...)&#39;, layout=(2,  1), xlabel=&quot;Iteration&quot;, ylabel=[&quot;r&quot; &quot;a&quot;], legend=false)</code></pre><img src="a60162e9.svg" alt="Example block output"/><h2 id="Un-linking-parameters"><a class="docs-heading-anchor" href="#Un-linking-parameters">Un-linking parameters</a><a id="Un-linking-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Un-linking-parameters" title="Permalink"></a></h2><p>One of the nice things about using Turing is that the DynamicPPL modeling language handles all the variable transformations, so that optimization and sampling can take place in  unconstrained parameter space even when you have bounded parameters (e.g. <code>r</code> in this  example). By default, <code>marginalize</code> sets up the <code>MarginalLogDensity</code> to use these unconstrained (a.k.a. &quot;linked&quot;, to use the language familiar from generalized linear modeling) parameters. </p><p>If you want transform them back to unlinked space, i.e. how they appear inside the model,  you need to construct a <code>VarInfo</code> and query it like this:</p><pre><code class="language-julia hljs">vi = VarInfo(marginal, opt_sol.u)
vi[@varname(r)]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">-0.1394580886609682</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../componentarrays/">« Using ComponentArrays</a><a class="docs-footer-nextpage" href="../api/">API Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Thursday 23 October 2025 23:15">Thursday 23 October 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
